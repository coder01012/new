<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>جارٍ تحويلك...</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBP0oQPZ4E9zaOYZGNVjqWxyjXde2SnOxs",
      authDomain: "short-link8288.firebaseapp.com",
      projectId: "short-link8288",
      storageBucket: "short-link8288.appspot.com",
      messagingSenderId: "316156644329",
      appId: "1:316156644329:web:ed593b1e7e465a01901978",
      measurementId: "G-HFG4329G97"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore();

    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");

    if (id) {
      const docRef = doc(db, "links", id);
      getDoc(docRef).then(async (docSnap) => {
        if (docSnap.exists()) {
          const ip = await fetch("https://api.ipify.org?format=json").then(res => res.json()).then(d => d.ip);
          await updateDoc(docRef, {
            clicks: increment(1),
            uniqueClicks: arrayUnion(ip),
          });
          location.href = docSnap.data().originalURL;
        } else {
          document.body.innerHTML = "<h1>الرابط غير موجود</h1>";
        }
      });
    } else {
      document.body.innerHTML = "<h1>لا يوجد معرف للرابط</h1>";
    }
  </script>
</head>
<body>
  <h1>⏳ جاري تحويلك...</h1>
</body>
</html>
